name: CI

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true

      - uses: actions/setup-node@v2
        with:
          node-version: "16"

      # - name: Install some stuff
      #   run: apt update && apt install -y wget

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y curl zsh wget build-essential gnupg fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf libxss1

      # - name: Install dependencies
      #   run: |
      #     apt-get update && sudo apt-get install -y curl zsh wget build-essential gnupg fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf libxss1

      - name: Install Google Chrome
        run: |
          sudo wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-unstable

      # - name: Install Google Chrome
      #   run: |
      #     wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
      #     sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
      #     apt-get update
      #     apt-get install -y google-chrome-unstable

      - name: Install MARP
        run: |
          npm install -g @marp-team/marp-cli

      - name: Build artifacts
        run: |
          make

      - name: Deploy to GDrive
        env:
          GDRIVE_TOKEN: ${{ secrets.CI_GDRIVE_TOKEN }}
        run: |
          wget https://github.com/prasmussen/gdrive/releases/download/2.1.1/gdrive_2.1.1_linux_386.tar.gz
          tar xzvf gdrive_2.1.1_linux_386.tar.gz
          chmod +x gdrive
          mv gdrive /usr/local/bin/gdrive
          mkdir -p ~/.gdrive && echo "$GDRIVE_TOKEN" > ~/.gdrive/token_v2.json
          # mkdir -p ~/.gdrive && cp token_v2.json | base64 --decode > ~/.gdrive/token_v2.json
          gdrive list
          gdrive list --query "name contains 'cansat2021'" --no-header --max 0 | cut -d" " -f1 - | xargs -L 1 gdrive delete -r
          gdrive mkdir cansat2021
          export TARGET_FOLDER=`gdrive list --query "name contains 'cansat2021'" --no-header --max 0 | cut -d" " -f1 -`
          gdrive upload --parent $TARGET_FOLDER drones-101/dist/drones-101/drones-101.pdf
          gdrive upload --parent $TARGET_FOLDER firedetection-101/lecture/dist/firedetection-101/firedetection-101.pdf
          gdrive upload --parent $TARGET_FOLDER platformio-101/lecture/dist/platformio-101/platformio-101.pdf
